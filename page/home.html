<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Handverse</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/7.8.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.8.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.8.1/firebase-database.js"></script>

  <script src="../js/firebase.js"></script>
  <script src="../js/auth.js" defer></script>

  <link rel="stylesheet" href="../css/reset.css">
  <link rel="stylesheet" href="../css/home.css">
</head>
  
<body>

  <header class="main-header">
    <div class="left-section">
      <p id="aproveitamento">Aproveitamento: 0%</p>
    </div>
    <img src="../assets/images/logoWhite1.png" alt="Logo do site" class="header-image">
    <a class="loja-button" href="https://handverse.lojavirtualnuvem.com.br/" alt="Loja">Loja</a>
    <button class="exit-button" onclick="signOut()">Sair</button>
  </header>

  <main>
    <div class="background-box">
      <div>
        <img class="imgregra" src="../assets/modulos/regras.jpeg" alt="Regras de convivÃªncia do site" />
      </div>
      <div class="text-container">
        <p>Bem-vindo(a)! Aqui Ã© um espaÃ§o para aprender Libras, conhecer pessoas e se divertir! Nosso objetivo Ã© criar
          um ambiente leve e inclusivo, onde todos possam se expressar com respeito e amizade. ğŸ’™</p>
      </div>
      <div class="rules">
        <h2>ğŸ‰ Como tornar a experiÃªncia incrÃ­vel?</h2>
        <ul>
          <li>âœ¨ <strong>Seja gentil</strong> â€“ Um simples sorriso ou gesto pode fazer o dia de alguÃ©m melhor!</li>
          <li>ğŸ’¬ <strong>Converse e faÃ§a amizades</strong> â€“ Aqui, cada conversa Ã© uma oportunidade para aprender e se
            conectar.</li>
          <li>ğŸš€ <strong>Compartilhe conhecimento</strong> â€“ Ajude quem estÃ¡ aprendendo e troque experiÃªncias!</li>
          <li>ğŸ“¹ <strong>Aproveite as videochamadas</strong> â€“ Participe dos encontros e divirta-se praticando Libras.
          </li>
          <li>ğŸ­ <strong>Expresse-se com respeito</strong> â€“ Todos tÃªm espaÃ§o para falar, desde que seja de forma
            inclusiva e amigÃ¡vel.</li>
          <li>ğŸ”’ <strong>Cuide da sua privacidade</strong> â€“ Evite compartilhar informaÃ§Ãµes pessoais em pÃºblico.</li>
          <li>âœ¨ <strong>Divirta-se!</strong> â€“ Este espaÃ§o Ã© para vocÃª! Sinta-se Ã  vontade para explorar e interagir. ğŸ˜Š
          </li>
        </ul>
      </div>
    </div>
  </main>

  <footer>
    <div class="image-links">
      <a href="../API WebCam/chamada.html">
        <img src="../assets/modulos/menina_libras_chamada.png" alt="video chamada">
      </a>
      <a href="./modulo.html">
        <img src="../assets/modulos/menino_libras_modulo.png" alt="mÃ³dulo de curso">
      </a>
    </div>
  </footer>

  <footer class="footer">
    &copy; 2025 Handverse. Todos os direitos reservados.
  </footer>

  <!-- VLibras -->
  <div vw class="enabled">
    <div vw-access-button class="active"></div>
    <div vw-plugin-wrapper>
      <div class="vw-plugin-top-wrapper"></div>
    </div>
  </div>

  <script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
  <script>
    new window.VLibras.Widget('https://vlibras.gov.br/app');
  </script>

<script>
  firebase.auth().onAuthStateChanged(user => {
    const elemento = document.getElementById("aproveitamento");

    if (!user) {
      elemento.textContent = "Aproveitamento: 0%";
      return;
    }

    const userEmail = user.email;
    const ref = firebase.database().ref("questionsXusers");

    // ğŸ”¹ Escuta apenas registros do usuÃ¡rio logado
    ref.orderByChild("user").equalTo(userEmail).on("value", snapshot => {
      const dados = snapshot.val();
      console.log("Dados do usuÃ¡rio:", dados);

      if (!dados) {
        elemento.textContent = "Aproveitamento: 0%";
        return;
      }

      // ğŸ”¹ Guarda o Ãºltimo registro por pergunta
      const ultimosPorPergunta = {}; // { questionId: { key, utilization } }

      for (let key in dados) {
        const registro = dados[key];
        if (!registro || !registro.question) continue;

        const q = registro.question;
        const util = Number(registro.utilization) || 0;

        // Se nÃ£o hÃ¡ ainda essa pergunta, ou este registro Ã© mais recente (key maior)
        if (!ultimosPorPergunta[q] || key > ultimosPorPergunta[q].key) {
          ultimosPorPergunta[q] = { key, utilization: util };
        }
      }

      // ğŸ”¹ Calcula mÃ©dia apenas das Ãºltimas tentativas
      const valores = Object.values(ultimosPorPergunta).map(x => x.utilization);
      const totalPerguntas = valores.length;

      const aproveitamento = totalPerguntas > 0
        ? valores.reduce((s, v) => s + v, 0) / totalPerguntas
        : 0;

      elemento.textContent = `Aproveitamento: ${aproveitamento.toFixed(0)}%`;

      console.log("Ãšltimos por pergunta:", ultimosPorPergunta);
      console.log("Aproveitamento final:", aproveitamento);
    }, error => {
      console.error("Erro ao ler dados:", error);
      elemento.textContent = "Aproveitamento: 0%";
    });
  });
</script>

<script src="../js/emailevoucher.js"></script>

</body>
</html>
